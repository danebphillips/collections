<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Collections Manager</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 1.8em;
            margin: 0;
        }

        .tabs {
            display: flex;
            background: #f5f5f5;
            border-bottom: 2px solid #ddd;
            overflow-x: auto;
        }

        .tab {
            padding: 15px 30px;
            cursor: pointer;
            border: none;
            background: transparent;
            font-size: 16px;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
            white-space: nowrap;
            border-bottom: 3px solid transparent;
        }

        .tab:hover {
            background: #e8e8e8;
            color: #333;
        }

        .tab.active {
            color: #667eea;
            background: white;
            border-bottom: 3px solid #667eea;
        }

        .content {
            padding: 20px;
            min-height: 500px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .search-box {
            flex: 1;
            min-width: 250px;
            padding: 12px 20px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .search-box:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .stat-card h3 {
            font-size: 13px;
            opacity: 0.9;
            margin: 0;
            font-weight: 600;
        }

        .stat-card .number {
            font-size: 24px;
            font-weight: bold;
            margin-left: 10px;
        }

        .items-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .item-card {
            border: 1px solid #ddd;
            border-radius: 12px;
            padding: 20px;
            background: white;
            transition: all 0.3s;
            cursor: pointer;
        }

        .item-card:hover {
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            transform: translateY(-4px);
        }

        .item-card img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 15px;
            background: #f0f0f0;
        }

        .item-card h3 {
            color: #333;
            margin-bottom: 10px;
            font-size: 18px;
        }

        .item-card .details {
            color: #666;
            font-size: 14px;
            line-height: 1.6;
        }

        .item-card .detail-row {
            margin-bottom: 5px;
        }

        .item-card .label {
            font-weight: 600;
            color: #333;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 30px;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-header {
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eee;
        }

        .modal-header h2 {
            color: #333;
            font-size: 24px;
        }

        .close-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 28px;
            cursor: pointer;
            color: #999;
            background: none;
            border: none;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s;
        }

        .close-btn:hover {
            background: #f0f0f0;
            color: #333;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            font-family: inherit;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .image-upload {
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .image-upload:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .image-upload input[type="file"] {
            display: none;
        }

        .image-preview {
            max-width: 100%;
            max-height: 300px;
            margin-top: 15px;
            border-radius: 8px;
        }

        .form-actions {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #eee;
        }

        .no-items {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .no-items svg {
            width: 80px;
            height: 80px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .photo-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .photo-container {
            position: relative;
            width: 100%;
            height: 150px;
        }

        .photo-gallery img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.3s;
            background: #f0f0f0;
        }

        .photo-gallery img:hover {
            transform: scale(1.05);
        }

        .photo-delete-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(220, 53, 69, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            font-size: 18px;
            line-height: 1;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .photo-delete-btn:hover {
            background: rgba(200, 35, 51, 1);
            transform: scale(1.1);
        }

        .photo-reorder-btns {
            position: absolute;
            bottom: 5px;
            left: 5px;
            display: flex;
            gap: 5px;
        }

        .photo-reorder-btn {
            background: rgba(102, 126, 234, 0.9);
            color: white;
            border: none;
            border-radius: 4px;
            width: 28px;
            height: 28px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .photo-reorder-btn:hover {
            background: rgba(85, 104, 211, 1);
            transform: scale(1.1);
        }

        .photo-reorder-btn:disabled {
            background: rgba(150, 150, 150, 0.5);
            cursor: not-allowed;
        }

        .main-photo-badge {
            position: absolute;
            top: 5px;
            left: 5px;
            background: rgba(40, 167, 69, 0.9);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .delete-btn {
            background: #dc3545;
            color: white;
            margin-top: 20px;
        }

        .delete-btn:hover {
            background: #c82333;
        }

        @media (max-width: 768px) {
            .items-grid {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 2em;
            }

            .controls {
                flex-direction: column;
            }

            .search-box {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üé® My Collections Manager</h1>
        </div>

        <div class="tabs" id="tabs-container">
            <!-- Tabs will be generated dynamically -->
        </div>

        <div class="content" id="content-container">
            <!-- Tab contents will be generated dynamically -->
        </div>
    </div>

    <!-- Modal for Add/Edit -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal()">√ó</button>
            <div class="modal-header">
                <h2 id="modal-title">Add Item</h2>
            </div>
            <div id="modal-form"></div>
        </div>
    </div>

    <script>
        // Data storage - now with dynamic tab support
        let collections = {
            posters: [],
            'baseball-singles': [],
            'uncut-sheets': []
        };

        // Tab configuration - user can modify this
        let tabConfig = [
            { id: 'posters', name: 'üñºÔ∏è Posters', icon: 'üñºÔ∏è', removable: false },
            { id: 'baseball-singles', name: '‚öæ Baseball Singles', icon: '‚öæ', removable: false },
            { id: 'uncut-sheets', name: 'üìÑ Uncut Sheets', icon: 'üìÑ', removable: false }
        ];

        let currentCollection = 'posters';
        let currentItem = null;

        // Initialize
        window.onload = function() {
            loadData();
            loadTabConfig();
            renderTabs();
            renderAll();
        };

        // Switch tabs
        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');

            currentCollection = tabName;
        }

        // Render tabs dynamically
        function renderTabs() {
            const tabsContainer = document.getElementById('tabs-container');
            const contentContainer = document.getElementById('content-container');
            
            // Render tab buttons
            let tabsHTML = tabConfig.map((tab, index) => `
                <button class="tab ${index === 0 ? 'active' : ''}" onclick="switchTab('${tab.id}')">
                    ${tab.name}
                </button>
            `).join('');
            
            tabsHTML += `<button class="tab" onclick="showTabManager()" style="margin-left: auto;">‚öôÔ∏è Manage Tabs</button>`;
            tabsContainer.innerHTML = tabsHTML;
            
            // Render tab contents
            contentContainer.innerHTML = tabConfig.map((tab, index) => {
                const displayName = tab.name.replace(/[^\w\s]/g, '').trim();
                const countId = tab.id === 'posters' ? 'posters' : 
                              tab.id === 'baseball-singles' ? 'baseball' :
                              tab.id === 'uncut-sheets' ? 'sheets' : tab.id.replace(/-/g, '');
                
                return `
                    <div id="${tab.id}" class="tab-content ${index === 0 ? 'active' : ''}">
                        <div class="stats">
                            <div class="stat-card">
                                <h3>Total ${displayName}</h3>
                                <div class="number" id="${countId}-count">0</div>
                            </div>
                        </div>

                        <div class="controls">
                            <input type="text" class="search-box" id="${tab.id}-search" placeholder="Search ${displayName.toLowerCase()}..." onkeyup="filterItems('${tab.id}')">
                            <button class="btn btn-primary" onclick="showAddModal('${tab.id}')">+ Add Item</button>
                            <button class="btn btn-secondary" onclick="exportData('${tab.id}')">üíæ Export Data</button>
                            <button class="btn btn-success" onclick="importData('${tab.id}')">üì• Import Data</button>
                            <button class="btn delete-btn" onclick="clearAllItems('${tab.id}')" style="background: #dc3545; margin-top: 0;">üóëÔ∏è Clear All</button>
                        </div>

                        <div id="${tab.id}-grid" class="items-grid"></div>
                    </div>
                `;
            }).join('');
        }

        // Show tab manager modal
        function showTabManager() {
            const existingModal = document.getElementById('tab-manager-modal');
            if (existingModal) {
                existingModal.remove();
            }

            const modalHTML = `
                <div id="tab-manager-modal" class="modal active">
                    <div class="modal-content">
                        <button class="close-btn" onclick="closeTabManager()">√ó</button>
                        <div class="modal-header">
                            <h2>Manage Collection Tabs</h2>
                        </div>
                        <div style="margin-bottom: 20px;">
                            <h3 style="margin-bottom: 15px;">Current Tabs</h3>
                            <div id="tab-list"></div>
                        </div>
                        <div>
                            <h3 style="margin-bottom: 15px;">Add New Tab</h3>
                            <div class="form-group">
                                <label>Tab Name *</label>
                                <input type="text" id="new-tab-name" placeholder="e.g., Football Cards">
                            </div>
                            <div class="form-group">
                                <label>Icon (emoji) *</label>
                                <input type="text" id="new-tab-icon" placeholder="e.g., üèà" maxlength="2">
                            </div>
                            <button class="btn btn-primary" onclick="addNewTab()">+ Add Tab</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            renderTabList();
        }

        function renderTabList() {
            const tabList = document.getElementById('tab-list');
            tabList.innerHTML = tabConfig.map(tab => `
                <div style="display: flex; align-items: center; padding: 12px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 10px; background: white;">
                    <span style="font-size: 24px; margin-right: 15px;">${tab.icon}</span>
                    <span style="flex: 1; font-weight: 600;">${tab.name}</span>
                    <span style="color: #666; margin-right: 15px;">${collections[tab.id]?.length || 0} items</span>
                    <button class="btn" style="background: #667eea; color: white; padding: 8px 16px; margin-right: 10px;" onclick="renameTab('${tab.id}')">Rename</button>
                    ${tab.removable !== false ? `<button class="btn" style="background: #dc3545; color: white; padding: 8px 16px;" onclick="removeTab('${tab.id}')">Remove</button>` : ''}
                </div>
            `).join('');
        }

        function addNewTab() {
            const name = document.getElementById('new-tab-name').value.trim();
            const icon = document.getElementById('new-tab-icon').value.trim();
            
            if (!name || !icon) {
                alert('Please provide both a name and an icon for the new tab.');
                return;
            }
            
            const id = name.toLowerCase().replace(/[^a-z0-9]+/g, '-');
            
            if (collections[id]) {
                alert('A tab with this name already exists.');
                return;
            }
            
            tabConfig.push({
                id: id,
                name: `${icon} ${name}`,
                icon: icon,
                removable: true
            });
            
            collections[id] = [];
            
            saveTabConfig();
            saveData();
            renderTabs();
            renderTabList();
            renderAll();
            
            document.getElementById('new-tab-name').value = '';
            document.getElementById('new-tab-icon').value = '';
            
            alert(`Tab "${name}" added successfully!`);
        }

        function removeTab(tabId) {
            const tab = tabConfig.find(t => t.id === tabId);
            const itemCount = collections[tabId]?.length || 0;
            
            if (!confirm(`Are you sure you want to remove the "${tab.name}" tab?\n\nThis will permanently delete all ${itemCount} items in this collection.\n\nThis action cannot be undone.`)) {
                return;
            }
            
            // Remove from tab config
            tabConfig = tabConfig.filter(t => t.id !== tabId);
            
            // Remove data
            delete collections[tabId];
            
            saveTabConfig();
            saveData();
            renderTabs();
            renderTabList();
            
            // Switch to first tab if we deleted the current one
            if (currentCollection === tabId) {
                currentCollection = tabConfig[0].id;
            }
            
            alert(`Tab "${tab.name}" and all its data have been removed.`);
        }

        function renameTab(tabId) {
            const tab = tabConfig.find(t => t.id === tabId);
            
            if (!tab) {
                alert('Tab not found.');
                return;
            }
            
            // Extract current name without emoji
            const currentNameParts = tab.name.split(' ');
            const currentIcon = currentNameParts[0];
            const currentName = currentNameParts.slice(1).join(' ');
            
            // Prompt for new name
            const newName = prompt(`Rename "${currentName}" to:`, currentName);
            
            if (!newName || newName.trim() === '') {
                return; // User cancelled or entered empty name
            }
            
            const trimmedName = newName.trim();
            
            // Check if name is actually different
            if (trimmedName === currentName) {
                alert('The name is the same. No changes made.');
                return;
            }
            
            // Prompt for new icon (optional - keep current if empty)
            const newIcon = prompt(`Icon for "${trimmedName}" (leave blank to keep "${currentIcon}"):`, currentIcon);
            
            const finalIcon = newIcon && newIcon.trim() !== '' ? newIcon.trim() : currentIcon;
            
            // Update the tab
            tab.name = `${finalIcon} ${trimmedName}`;
            tab.icon = finalIcon;
            
            saveTabConfig();
            renderTabs();
            renderTabList();
            
            alert(`Tab renamed to "${tab.name}" successfully!`);
        }

        function closeTabManager() {
            document.getElementById('tab-manager-modal').remove();
        }

        function saveTabConfig() {
            localStorage.setItem('tabConfig', JSON.stringify(tabConfig));
        }

        function loadTabConfig() {
            const saved = localStorage.getItem('tabConfig');
            if (saved) {
                tabConfig = JSON.parse(saved);
                // Ensure all tabs have collections initialized
                tabConfig.forEach(tab => {
                    if (!collections[tab.id]) {
                        collections[tab.id] = [];
                    }
                });
            }
        }

        // Show add/edit modal
        function showAddModal(collection, item = null) {
            currentCollection = collection;
            currentItem = item;

            const modal = document.getElementById('modal');
            const modalTitle = document.getElementById('modal-title');
            const modalForm = document.getElementById('modal-form');

            modalTitle.textContent = item ? 'Edit Item' : 'Add New Item';

            // Generate form based on collection type
            let formHTML = '';

            if (collection === 'posters') {
                formHTML = `
                    <div class="form-group">
                        <label>Poster Name *</label>
                        <input type="text" id="field-name" value="${item?.name || ''}" required>
                    </div>
                    <div class="form-group">
                        <label>Year</label>
                        <input type="number" id="field-year" value="${item?.year || ''}">
                    </div>
                    <div class="form-group">
                        <label>Artist</label>
                        <input type="text" id="field-artist" value="${item?.artist || ''}">
                    </div>
                    <div class="form-group">
                        <label>Dimensions</label>
                        <input type="text" id="field-dimensions" value="${item?.dimensions || ''}" placeholder="e.g., 24x36 inches">
                    </div>
                    <div class="form-group">
                        <label>Edition</label>
                        <input type="text" id="field-edition" value="${item?.edition || ''}" placeholder="e.g., Show, Artist, Variant">
                    </div>
                    <div class="form-group">
                        <label>Condition</label>
                        <select id="field-condition">
                            <option value="">Select condition</option>
                            <option ${item?.condition === 'Mint' ? 'selected' : ''}>Mint</option>
                            <option ${item?.condition === 'Near Mint' ? 'selected' : ''}>Near Mint</option>
                            <option ${item?.condition === 'Excellent' ? 'selected' : ''}>Excellent</option>
                            <option ${item?.condition === 'Very Good' ? 'selected' : ''}>Very Good</option>
                            <option ${item?.condition === 'Good' ? 'selected' : ''}>Good</option>
                            <option ${item?.condition === 'Fair' ? 'selected' : ''}>Fair</option>
                            <option ${item?.condition === 'Poor' ? 'selected' : ''}>Poor</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Estimated Value</label>
                        <input type="text" id="field-value" value="${item?.value || ''}" placeholder="e.g., $500">
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="field-notes">${item?.notes || ''}</textarea>
                    </div>
                    <div class="form-group">
                        <label>Purchase Date</label>
                        <input type="date" id="field-purchase-date" value="${item?.purchaseDate || ''}">
                    </div>
                    <div class="form-group">
                        <label>Purchase Price</label>
                        <input type="text" id="field-purchase-price" value="${item?.purchasePrice || ''}" placeholder="e.g., $200">
                    </div>
                    <div class="form-group">
                        <label>Photos</label>
                        <div class="image-upload" onclick="document.getElementById('photo-input').click()">
                            <input type="file" id="photo-input" accept="image/*" multiple onchange="handlePhotoUpload(event)">
                            <p>üì∑ Click to add photos</p>
                        </div>
                        <div id="photo-preview" class="photo-gallery"></div>
                    </div>
                `;
            } else if (collection === 'baseball-singles') {
                formHTML = `
                    <div class="form-group">
                        <label>Set Name *</label>
                        <input type="text" id="field-set" value="${item?.set || ''}" required>
                    </div>
                    <div class="form-group">
                        <label>Card Number</label>
                        <input type="text" id="field-card-number" value="${item?.cardNumber || ''}">
                    </div>
                    <div class="form-group">
                        <label>Card/Player *</label>
                        <input type="text" id="field-player" value="${item?.player || ''}" required>
                    </div>
                    <div class="form-group">
                        <label>Quantity</label>
                        <input type="number" id="field-quantity" value="${item?.quantity || '1'}" min="1">
                    </div>
                    <div class="form-group">
                        <label>Condition</label>
                        <input type="text" id="field-condition" value="${item?.condition || ''}" placeholder="e.g., EX-MT+">
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="field-notes">${item?.notes || ''}</textarea>
                    </div>
                    <div class="form-group">
                        <label>Purchase Price</label>
                        <input type="text" id="field-purchase-price" value="${item?.purchasePrice || ''}">
                    </div>
                    <div class="form-group">
                        <label>Purchase Date</label>
                        <input type="date" id="field-purchase-date" value="${item?.purchaseDate || ''}">
                    </div>
                    <div class="form-group">
                        <label>Photos</label>
                        <div class="image-upload" onclick="document.getElementById('photo-input').click()">
                            <input type="file" id="photo-input" accept="image/*" multiple onchange="handlePhotoUpload(event)">
                            <p>üì∑ Click to add photos</p>
                        </div>
                        <div id="photo-preview" class="photo-gallery"></div>
                    </div>
                `;
            } else if (collection === 'uncut-sheets') {
                formHTML = `
                    <div class="form-group">
                        <label>Year *</label>
                        <input type="text" id="field-year" value="${item?.year || ''}" required>
                    </div>
                    <div class="form-group">
                        <label>Sport *</label>
                        <select id="field-sport">
                            <option value="">Select sport</option>
                            <option ${item?.sport === 'Baseball' ? 'selected' : ''}>Baseball</option>
                            <option ${item?.sport === 'Basketball' ? 'selected' : ''}>Basketball</option>
                            <option ${item?.sport === 'Football' ? 'selected' : ''}>Football</option>
                            <option ${item?.sport === 'Hockey' ? 'selected' : ''}>Hockey</option>
                            <option ${item?.sport === 'Other' ? 'selected' : ''}>Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Set *</label>
                        <input type="text" id="field-set" value="${item?.set || ''}" required>
                    </div>
                    <div class="form-group">
                        <label>Cards Per Sheet</label>
                        <input type="number" id="field-cards-per-sheet" value="${item?.cardsPerSheet || ''}" min="1">
                    </div>
                    <div class="form-group">
                        <label>Quantity</label>
                        <input type="number" id="field-quantity" value="${item?.quantity || '1'}" min="1">
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="field-notes">${item?.notes || ''}</textarea>
                    </div>
                    <div class="form-group">
                        <label>Photos</label>
                        <div class="image-upload" onclick="document.getElementById('photo-input').click()">
                            <input type="file" id="photo-input" accept="image/*" multiple onchange="handlePhotoUpload(event)">
                            <p>üì∑ Click to add photos</p>
                        </div>
                        <div id="photo-preview" class="photo-gallery"></div>
                    </div>
                `;
            } else {
                // Generic form for custom tabs
                formHTML = `
                    <div class="form-group">
                        <label>Name/Description *</label>
                        <input type="text" id="field-description" value="${item?.description || ''}" required>
                    </div>
                    <div class="form-group">
                        <label>Set/Category</label>
                        <input type="text" id="field-set" value="${item?.set || ''}">
                    </div>
                    <div class="form-group">
                        <label>Number/ID</label>
                        <input type="text" id="field-cardNumber" value="${item?.cardNumber || ''}">
                    </div>
                    <div class="form-group">
                        <label>Condition</label>
                        <input type="text" id="field-condition" value="${item?.condition || ''}">
                    </div>
                    <div class="form-group">
                        <label>Quantity</label>
                        <input type="number" id="field-quantity" value="${item?.quantity || '1'}" min="1">
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="field-notes">${item?.notes || ''}</textarea>
                    </div>
                    <div class="form-group">
                        <label>Photos</label>
                        <div class="image-upload" onclick="document.getElementById('photo-input').click()">
                            <input type="file" id="photo-input" accept="image/*" multiple onchange="handlePhotoUpload(event)">
                            <p>üì∑ Click to add photos</p>
                        </div>
                        <div id="photo-preview" class="photo-gallery"></div>
                    </div>
                `;
            }

            formHTML += `
                <div class="form-actions">
                    <button class="btn btn-primary" onclick="saveItem()">${item ? 'Update' : 'Add'} Item</button>
                    <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    ${item ? '<button class="btn delete-btn" onclick="deleteItem()">Delete</button>' : ''}
                </div>
            `;

            modalForm.innerHTML = formHTML;

            // Show existing photos if editing
            if (item && item.photos && item.photos.length > 0) {
                displayPhotoPreviews(item.photos);
            }

            modal.classList.add('active');
        }

        // Handle photo uploads
        let uploadedPhotos = [];

        function handlePhotoUpload(event) {
            const files = event.target.files;
            uploadedPhotos = currentItem?.photos || [];

            for (let file of files) {
                // Check file size (limit to 5MB per image to avoid localStorage issues)
                if (file.size > 5 * 1024 * 1024) {
                    alert(`${file.name} is too large (${(file.size / 1024 / 1024).toFixed(1)}MB). Please use images under 5MB.`);
                    continue;
                }

                // Check file type
                if (!file.type.startsWith('image/')) {
                    alert(`${file.name} is not an image file.`);
                    continue;
                }

                const reader = new FileReader();
                reader.onerror = function() {
                    alert(`Error reading ${file.name}. Please try a different image.`);
                };
                reader.onload = function(e) {
                    // Create an image to check if it's valid
                    const img = new Image();
                    img.onerror = function() {
                        alert(`${file.name} appears to be corrupted or in an unsupported format.`);
                    };
                    img.onload = function() {
                        // If image is very large, resize it
                        if (img.width > 2000 || img.height > 2000) {
                            const canvas = document.createElement('canvas');
                            let width = img.width;
                            let height = img.height;
                            
                            // Calculate new dimensions (max 2000px on longest side)
                            const maxSize = 2000;
                            if (width > height && width > maxSize) {
                                height = (height / width) * maxSize;
                                width = maxSize;
                            } else if (height > maxSize) {
                                width = (width / height) * maxSize;
                                height = maxSize;
                            }
                            
                            canvas.width = width;
                            canvas.height = height;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, width, height);
                            
                            // Convert back to data URL with compression
                            const resizedDataUrl = canvas.toDataURL('image/jpeg', 0.85);
                            uploadedPhotos.push(resizedDataUrl);
                            displayPhotoPreviews(uploadedPhotos);
                        } else {
                            // Image is reasonable size, use as-is
                            uploadedPhotos.push(e.target.result);
                            displayPhotoPreviews(uploadedPhotos);
                        }
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        }

        function displayPhotoPreviews(photos) {
            const preview = document.getElementById('photo-preview');
            preview.innerHTML = photos.map((photo, index) => {
                // Check if photo data exists and is valid
                const isValidPhoto = photo && (photo.startsWith('data:image/') || photo.startsWith('http'));
                
                return `
                <div class="photo-container">
                    ${isValidPhoto ? 
                        `<img src="${photo}" alt="Photo ${index + 1}" onclick="viewPhoto('${photo.replace(/'/g, "\\'")}')">` :
                        `<div style="width:100%;height:150px;background:#f0f0f0;display:flex;align-items:center;justify-content:center;color:#999;border-radius:8px;">Invalid Image</div>`
                    }
                    ${index === 0 ? '<div class="main-photo-badge">MAIN</div>' : ''}
                    <button class="photo-delete-btn" onclick="event.stopPropagation(); deletePhoto(${index});" title="Delete photo">√ó</button>
                    <div class="photo-reorder-btns">
                        <button class="photo-reorder-btn" onclick="event.stopPropagation(); movePhotoLeft(${index});" title="Move left" ${index === 0 ? 'disabled' : ''}>‚Üê</button>
                        <button class="photo-reorder-btn" onclick="event.stopPropagation(); movePhotoRight(${index});" title="Move right" ${index === photos.length - 1 ? 'disabled' : ''}>‚Üí</button>
                    </div>
                </div>
            `;
            }).join('');
        }

        function deletePhoto(index) {
            if (confirm('Remove this photo?')) {
                uploadedPhotos.splice(index, 1);
                displayPhotoPreviews(uploadedPhotos);
            }
        }

        function movePhotoLeft(index) {
            if (index > 0) {
                // Swap with previous photo
                [uploadedPhotos[index - 1], uploadedPhotos[index]] = [uploadedPhotos[index], uploadedPhotos[index - 1]];
                displayPhotoPreviews(uploadedPhotos);
            }
        }

        function movePhotoRight(index) {
            if (index < uploadedPhotos.length - 1) {
                // Swap with next photo
                [uploadedPhotos[index], uploadedPhotos[index + 1]] = [uploadedPhotos[index + 1], uploadedPhotos[index]];
                displayPhotoPreviews(uploadedPhotos);
            }
        }

        function viewPhoto(photoUrl) {
            // Open photo in a new window for full view
            const win = window.open();
            win.document.write(`
                <html>
                <head><title>Photo Viewer</title></head>
                <body style="margin:0;display:flex;align-items:center;justify-content:center;background:#000;">
                    <img src="${photoUrl}" style="max-width:100%;max-height:100vh;object-fit:contain;">
                </body>
                </html>
            `);
        }

        // Save item
        function saveItem() {
            let item = {};

            if (currentCollection === 'posters') {
                item = {
                    id: currentItem?.id || Date.now(),
                    name: document.getElementById('field-name').value,
                    year: document.getElementById('field-year').value,
                    artist: document.getElementById('field-artist').value,
                    dimensions: document.getElementById('field-dimensions').value,
                    edition: document.getElementById('field-edition').value,
                    condition: document.getElementById('field-condition').value,
                    value: document.getElementById('field-value').value,
                    notes: document.getElementById('field-notes').value,
                    purchaseDate: document.getElementById('field-purchase-date').value,
                    purchasePrice: document.getElementById('field-purchase-price').value,
                    photos: uploadedPhotos
                };
            } else if (currentCollection === 'baseball-singles') {
                item = {
                    id: currentItem?.id || Date.now(),
                    set: document.getElementById('field-set').value,
                    cardNumber: document.getElementById('field-card-number').value,
                    player: document.getElementById('field-player').value,
                    quantity: document.getElementById('field-quantity').value,
                    condition: document.getElementById('field-condition').value,
                    notes: document.getElementById('field-notes').value,
                    purchasePrice: document.getElementById('field-purchase-price').value,
                    purchaseDate: document.getElementById('field-purchase-date').value,
                    photos: uploadedPhotos
                };
            } else if (currentCollection === 'uncut-sheets') {
                item = {
                    id: currentItem?.id || Date.now(),
                    year: document.getElementById('field-year').value,
                    sport: document.getElementById('field-sport').value,
                    set: document.getElementById('field-set').value,
                    cardsPerSheet: document.getElementById('field-cards-per-sheet').value,
                    quantity: document.getElementById('field-quantity').value,
                    notes: document.getElementById('field-notes').value,
                    photos: uploadedPhotos
                };
            } else {
                // Generic handling for custom tabs
                item = {
                    id: currentItem?.id || Date.now(),
                    description: document.getElementById('field-description')?.value || '',
                    set: document.getElementById('field-set')?.value || '',
                    cardNumber: document.getElementById('field-cardNumber')?.value || '',
                    condition: document.getElementById('field-condition')?.value || '',
                    quantity: document.getElementById('field-quantity')?.value || '1',
                    notes: document.getElementById('field-notes')?.value || '',
                    photos: uploadedPhotos
                };
            }

            if (currentItem) {
                // Update existing
                const index = collections[currentCollection].findIndex(i => i.id === currentItem.id);
                collections[currentCollection][index] = item;
            } else {
                // Add new
                collections[currentCollection].push(item);
            }

            saveData();
            renderCollection(currentCollection);
            closeModal();
            uploadedPhotos = [];
        }

        // Delete item
        function deleteItem() {
            if (confirm('Are you sure you want to delete this item?')) {
                collections[currentCollection] = collections[currentCollection].filter(i => i.id !== currentItem.id);
                saveData();
                renderCollection(currentCollection);
                closeModal();
            }
        }

        // Clear all items in a collection
        function clearAllItems(collection) {
            const tabName = tabConfig.find(t => t.id === collection)?.name || collection;
            const itemCount = collections[collection]?.length || 0;
            
            if (itemCount === 0) {
                alert('This collection is already empty.');
                return;
            }
            
            const confirmMessage = `‚ö†Ô∏è WARNING: This will permanently delete ALL ${itemCount} items in "${tabName}".\n\nThis includes all photos and data.\n\nThis action CANNOT be undone.\n\nAre you absolutely sure?`;
            
            if (!confirm(confirmMessage)) {
                return;
            }
            
            // Double confirmation for safety
            const doubleCheck = prompt(`Type "DELETE" (in capital letters) to confirm deletion of all ${itemCount} items:`);
            
            if (doubleCheck !== 'DELETE') {
                alert('Deletion cancelled. Your data is safe.');
                return;
            }
            
            // Clear the collection
            collections[collection] = [];
            saveData();
            renderCollection(collection);
            
            alert(`All items in "${tabName}" have been deleted.\n\nYou can now import clean data or start fresh.`);
        }

        // Close modal
        function closeModal() {
            document.getElementById('modal').classList.remove('active');
            currentItem = null;
            uploadedPhotos = [];
        }

        // Sort collections
        function sortCollection(collection) {
            if (collection === 'posters') {
                // Sort by year (ascending), then by name
                collections[collection].sort((a, b) => {
                    const yearA = parseInt(a.year) || 0;
                    const yearB = parseInt(b.year) || 0;
                    if (yearA !== yearB) {
                        return yearA - yearB;
                    }
                    return (a.name || '').localeCompare(b.name || '');
                });
            } else if (collection === 'baseball-singles') {
                // Sort by set name, then by card number (numeric)
                collections[collection].sort((a, b) => {
                    const setCompare = (a.set || '').localeCompare(b.set || '');
                    if (setCompare !== 0) {
                        return setCompare;
                    }
                    const numA = parseInt(a.cardNumber) || 0;
                    const numB = parseInt(b.cardNumber) || 0;
                    return numA - numB;
                });
            } else if (collection === 'uncut-sheets') {
                // Sort by year, then sport, then set
                collections[collection].sort((a, b) => {
                    const yearCompare = (a.year || '').localeCompare(b.year || '');
                    if (yearCompare !== 0) {
                        return yearCompare;
                    }
                    const sportCompare = (a.sport || '').localeCompare(b.sport || '');
                    if (sportCompare !== 0) {
                        return sportCompare;
                    }
                    return (a.set || '').localeCompare(b.set || '');
                });
            } else if (collection === 'vintage-cards') {
                // Sort by set name, then by card number (numeric)
                collections[collection].sort((a, b) => {
                    const setCompare = (a.set || '').localeCompare(b.set || '');
                    if (setCompare !== 0) {
                        return setCompare;
                    }
                    const numA = parseInt(a.cardNumber) || 0;
                    const numB = parseInt(b.cardNumber) || 0;
                    return numA - numB;
                });
            }
        }

        // Render collection
        function renderCollection(collection) {
            // Sort before rendering
            sortCollection(collection);
            
            const grid = document.getElementById(`${collection}-grid`);
            const items = collections[collection];
            const countEl = document.getElementById(`${collection === 'posters' ? 'posters' : collection === 'baseball-singles' ? 'baseball' : collection === 'uncut-sheets' ? 'sheets' : 'vintage'}-count`);

            if (countEl) countEl.textContent = items.length;

            if (items.length === 0) {
                grid.innerHTML = `
                    <div class="no-items">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path>
                        </svg>
                        <h3>No items yet</h3>
                        <p>Click "Add" to start building your collection</p>
                    </div>
                `;
                return;
            }

            grid.innerHTML = items.map(item => {
                let cardContent = '';

                if (collection === 'posters') {
                    cardContent = `
                        <h3>${item.name}</h3>
                        <div class="details">
                            ${item.year ? `<div class="detail-row"><span class="label">Year:</span> ${item.year}</div>` : ''}
                            ${item.artist ? `<div class="detail-row"><span class="label">Artist:</span> ${item.artist}</div>` : ''}
                            ${item.edition ? `<div class="detail-row"><span class="label">Edition:</span> ${item.edition}</div>` : ''}
                            ${item.dimensions ? `<div class="detail-row"><span class="label">Size:</span> ${item.dimensions}</div>` : ''}
                            ${item.condition ? `<div class="detail-row"><span class="label">Condition:</span> ${item.condition}</div>` : ''}
                            ${item.value ? `<div class="detail-row"><span class="label">Value:</span> ${item.value}</div>` : ''}
                        </div>
                    `;
                } else if (collection === 'baseball-singles') {
                    cardContent = `
                        <h3>${item.player}</h3>
                        <div class="details">
                            <div class="detail-row"><span class="label">Set:</span> ${item.set}</div>
                            ${item.cardNumber ? `<div class="detail-row"><span class="label">Card #:</span> ${item.cardNumber}</div>` : ''}
                            ${item.condition ? `<div class="detail-row"><span class="label">Condition:</span> ${item.condition}</div>` : ''}
                            ${item.quantity ? `<div class="detail-row"><span class="label">Qty:</span> ${item.quantity}</div>` : ''}
                        </div>
                    `;
                } else if (collection === 'uncut-sheets') {
                    // Build title as "Year Set Sport"
                    const titleParts = [];
                    if (item.year) titleParts.push(item.year);
                    if (item.set) titleParts.push(item.set);
                    if (item.sport) titleParts.push(item.sport);
                    const title = titleParts.join(' ') || 'Uncut Sheet';
                    
                    cardContent = `
                        <h3>${title}</h3>
                        <div class="details">
                            ${item.cardsPerSheet ? `<div class="detail-row"><span class="label">Cards/Sheet:</span> ${item.cardsPerSheet}</div>` : ''}
                            ${item.quantity ? `<div class="detail-row"><span class="label">Qty:</span> ${item.quantity}</div>` : ''}
                        </div>
                    `;
                } else if (collection === 'vintage-cards') {
                } else {
                    // Generic rendering for custom tabs
                    cardContent = `
                        <h3>${item.description || item.name || 'Untitled'}</h3>
                        <div class="details">
                            ${item.set ? `<div class="detail-row"><span class="label">Set:</span> ${item.set}</div>` : ''}
                            ${item.cardNumber ? `<div class="detail-row"><span class="label">Number:</span> ${item.cardNumber}</div>` : ''}
                            ${item.condition ? `<div class="detail-row"><span class="label">Condition:</span> ${item.condition}</div>` : ''}
                            ${item.quantity ? `<div class="detail-row"><span class="label">Qty:</span> ${item.quantity}</div>` : ''}
                        </div>
                    `;
                }

                return `
                    <div class="item-card" onclick='showAddModal("${collection}", ${JSON.stringify(item).replace(/'/g, "&#39;")})'>
                        ${item.photos && item.photos.length > 0 ? `<img src="${item.photos[0]}" alt="${item.name || item.player || item.description}">` : '<img src="data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'200\' height=\'200\'%3E%3Crect fill=\'%23f0f0f0\' width=\'200\' height=\'200\'/%3E%3Ctext fill=\'%23999\' font-family=\'sans-serif\' font-size=\'14\' x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' dominant-baseline=\'middle\'%3ENo Photo%3C/text%3E%3C/svg%3E" alt="No photo">'}
                        ${cardContent}
                    </div>
                `;
            }).join('');
        }

        // Render all collections
        function renderAll() {
            tabConfig.forEach(tab => {
                if (collections[tab.id]) {
                    renderCollection(tab.id);
                }
            });
        }

        // Filter items
        function filterItems(collection) {
            const searchBox = document.getElementById(`${collection}-search`);
            const searchTerm = searchBox.value.toLowerCase();
            const grid = document.getElementById(`${collection}-grid`);
            const cards = grid.querySelectorAll('.item-card');

            cards.forEach(card => {
                const text = card.textContent.toLowerCase();
                card.style.display = text.includes(searchTerm) ? 'block' : 'none';
            });
        }

        // Save to localStorage
        function saveData() {
            localStorage.setItem('collections', JSON.stringify(collections));
        }

        // Load from localStorage
        function loadData() {
            const saved = localStorage.getItem('collections');
            if (saved) {
                collections = JSON.parse(saved);
            }
        }

        // Export data
        function exportData(collection) {
            const data = JSON.stringify(collections[collection], null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${collection}-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
        }

        // Import data with smart merge
        function importData(collection) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        const imported = JSON.parse(event.target.result);
                        showImportOptions(collection, imported);
                    } catch (error) {
                        alert('Error importing file. Please check the file format.');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function showImportOptions(collection, importedData) {
            const existingCount = collections[collection]?.length || 0;
            const importCount = importedData.length;
            
            const modalHTML = `
                <div id="import-modal" class="modal active">
                    <div class="modal-content">
                        <button class="close-btn" onclick="closeImportModal()">√ó</button>
                        <div class="modal-header">
                            <h2>Import Options</h2>
                        </div>
                        <p style="margin-bottom: 20px;">
                            You're importing <strong>${importCount} items</strong>.<br>
                            You currently have <strong>${existingCount} items</strong> in this collection.
                        </p>
                        <div style="margin-bottom: 20px;">
                            <h3 style="margin-bottom: 15px;">How would you like to import?</h3>
                            <button class="btn btn-primary" onclick="doImport('${collection}', 'merge')" style="width: 100%; margin-bottom: 10px; padding: 15px;">
                                üì• <strong>Smart Merge</strong><br>
                                <small style="opacity: 0.8;">Add new items and update existing ones (recommended)</small>
                            </button>
                            <button class="btn btn-secondary" onclick="doImport('${collection}', 'replace')" style="width: 100%; padding: 15px;">
                                üîÑ <strong>Replace All</strong><br>
                                <small style="opacity: 0.8;">Delete existing data and replace with imported data</small>
                            </button>
                        </div>
                        <p style="font-size: 14px; color: #666;">
                            <strong>Smart Merge:</strong> Compares items by key fields (name, set, player, etc.) and only adds truly new items. Updates existing items with new data.<br><br>
                            <strong>Replace All:</strong> Removes all current data and replaces it with the imported file.
                        </p>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Store imported data temporarily
            window.pendingImport = importedData;
        }

        function closeImportModal() {
            const modal = document.getElementById('import-modal');
            if (modal) modal.remove();
            window.pendingImport = null;
        }

        function doImport(collection, mode) {
            const imported = window.pendingImport;
            if (!imported) return;
            
            if (mode === 'replace') {
                collections[collection] = imported;
                saveData();
                renderCollection(collection);
                closeImportModal();
                alert(`Imported ${imported.length} items (replaced all existing data).`);
            } else if (mode === 'merge') {
                const result = smartMerge(collection, imported);
                saveData();
                renderCollection(collection);
                closeImportModal();
                alert(`Import complete!\n\nAdded: ${result.added} new items\nUpdated: ${result.updated} existing items\nSkipped: ${result.skipped} duplicates\nTotal: ${collections[collection].length} items`);
            }
        }

        function smartMerge(collection, importedData) {
            const existing = collections[collection] || [];
            let added = 0;
            let updated = 0;
            let skipped = 0;
            
            // Define key fields for each collection type to identify duplicates
            const getItemKey = (item, collectionType) => {
                if (collectionType === 'posters') {
                    return `${item.name}|${item.year}|${item.artist}`.toLowerCase();
                } else if (collectionType === 'baseball-singles') {
                    return `${item.set}|${item.cardNumber}|${item.player}`.toLowerCase();
                } else if (collectionType === 'uncut-sheets') {
                    return `${item.year}|${item.sport}|${item.set}`.toLowerCase();
                } else {
                    // Generic: use set, card number, and description
                    return `${item.set}|${item.cardNumber}|${item.description}`.toLowerCase();
                }
            };
            
            // Create a map of existing items
            const existingMap = new Map();
            existing.forEach((item, index) => {
                const key = getItemKey(item, collection);
                existingMap.set(key, { item, index });
            });
            
            // Process imported items
            importedData.forEach(importedItem => {
                const key = getItemKey(importedItem, collection);
                const existingEntry = existingMap.get(key);
                
                if (existingEntry) {
                    // Item exists - check if it's actually different
                    const existingItem = existingEntry.item;
                    const isDifferent = JSON.stringify(existingItem) !== JSON.stringify(importedItem);
                    
                    if (isDifferent) {
                        // Update existing item, preserving photos if new item doesn't have them
                        if (!importedItem.photos || importedItem.photos.length === 0) {
                            importedItem.photos = existingItem.photos || [];
                        }
                        importedItem.id = existingItem.id; // Preserve ID
                        existing[existingEntry.index] = importedItem;
                        updated++;
                    } else {
                        skipped++;
                    }
                } else {
                    // New item - add it
                    importedItem.id = importedItem.id || Date.now() + added;
                    existing.push(importedItem);
                    added++;
                }
            });
            
            collections[collection] = existing;
            return { added, updated, skipped };
        }
    </script>
</body>
</html>
